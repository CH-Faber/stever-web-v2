# 日志系统迁移指南

## 概述

新的日志持久化系统与旧系统完全兼容，无需任何迁移操作。

## 变化说明

### 旧系统
- 日志仅存储在内存中
- 机器人停止后日志丢失
- 最多保留 1000 条日志

### 新系统
- 日志同时存储在内存和文件中
- 每次启动创建独立的日志会话
- 历史日志永久保存
- 内存中仍保留最近 1000 条用于实时显示

## 升级步骤

### 1. 更新代码

```bash
# 拉取最新代码
git pull

# 安装依赖
cd server && npm install
cd ../client && npm install

# 编译
cd ../server && npm run build
cd ../client && npm run build
```

### 2. 启动服务

```bash
# 启动后端
cd server && npm start

# 启动前端（新终端）
cd client && npm run dev
```

### 3. 验证功能

1. 启动一个机器人
2. 查看实时日志是否正常显示
3. 停止机器人
4. 点击"历史日志"按钮
5. 确认可以看到刚才的日志会话

## 数据存储

新系统会在项目根目录创建 `logs/` 文件夹：

```
your-project/
├── logs/              # 新增：日志存储目录
│   ├── sessions.json  # 会话索引
│   └── *.jsonl        # 日志文件
├── profiles/
├── server/
├── client/
└── ...
```

## 兼容性

### 向后兼容
- ✅ 所有现有功能保持不变
- ✅ 实时日志显示方式不变
- ✅ WebSocket 通信协议不变
- ✅ API 接口保持兼容

### 新增功能
- ✅ 历史日志查看
- ✅ 日志会话管理
- ✅ 日志下载
- ✅ 日志过滤

## 性能影响

### 内存使用
- 无明显变化（仍保留 1000 条在内存）

### 磁盘使用
- 每小时约 1-5 MB（取决于日志量）
- 建议定期清理旧日志

### CPU 使用
- 写入日志时有轻微增加（异步写入，不阻塞）
- 对整体性能影响可忽略

## 故障排查

### 日志文件未创建

**症状**: 机器人运行但 `logs/` 目录为空

**解决方案**:
1. 检查目录权限
2. 查看服务器控制台是否有错误
3. 确认服务器正常启动

### 历史日志页面空白

**症状**: 点击"历史日志"按钮后页面空白

**解决方案**:
1. 检查浏览器控制台错误
2. 确认 API 端点 `/api/logs/sessions` 可访问
3. 检查 `logs/sessions.json` 是否存在

### 日志写入失败

**症状**: 服务器日志显示写入错误

**解决方案**:
1. 检查磁盘空间
2. 检查文件权限
3. 确认 `logs/` 目录可写

## 回滚方案

如果需要回滚到旧版本：

1. 停止服务
2. 切换到旧版本代码
3. 删除 `logs/` 目录（可选）
4. 重新启动服务

注意：回滚后历史日志功能将不可用，但不影响其他功能。

## 数据备份

建议定期备份 `logs/` 目录：

```bash
# 创建备份
tar -czf logs-backup-$(date +%Y%m%d).tar.gz logs/

# 恢复备份
tar -xzf logs-backup-20260116.tar.gz
```

## 未来计划

- [ ] 自动清理旧日志
- [ ] 日志压缩
- [ ] 日志搜索
- [ ] 日志分析和统计
- [ ] 日志导出为多种格式

## 支持

如有问题，请：
1. 查看 [LOG_QUICKSTART.md](./LOG_QUICKSTART.md)
2. 查看 [LOG_PERSISTENCE.md](./LOG_PERSISTENCE.md)
3. 提交 GitHub Issue
